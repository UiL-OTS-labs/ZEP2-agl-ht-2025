
import agl_records;

string[] l1_grammatical = {
    "baa_daa_meu",
    "baa_geu_meu",
    "soe_daa_goo",
    "soe_geu_goo",
};

string[] l1_ungrammatical = {
    "meu_baa_daa",
    "geu_meu_baa",
    "daa_goo_soe",
    "goo_soe_geu",
}

string [] l2_grammatical = l1_ungrammatical;
string [] l2_ungrammatical = l1_grammatical;

string[] familiar;
string[] ungrammatical;

TestItem[] test_items = {};

string array_pop_string(string[] items) {
    string ret = items[items.size-1];
    items.size = items.size - 1;
    return ret;
}

void append_test_item(TestItem[] items, TestItem item) {
    items.size = items.size + 1;
    items[items.size - 1] = item;
}

TestItem
create_test_item(LanguageType language, TestOrder order, int block) {

    TestItem init;
    init.id = -1;
    init.language = language;
    init.order = order;
    init.test_block = block;
    init.sound_direction = PSEUDO_RANDOM_SIDE;

    return init; 
}

TestItem
create_grammatical(LanguageType language, TestOrder order, int block) {
    TestItem item  = create_test_item(language, order, block);
    item.test_type = TT_FAMILIAR;
    item.sndfn     = array_pop_string(familiar);
    return item;
}

TestItem
create_ungrammatical(LanguageType language, TestOrder order, int block) {
    TestItem item  = create_test_item(language, order, block);
    item.test_type = TT_UNGRAMMATICAL;
    item.sndfn     = array_pop_string(ungrammatical);
    return item;
}

void
prepare_stimuli_lists() {
    string slt = expdb.participant.get_enum_field("language");

    if (slt == "l1") {
        grammatical = l1_grammatical;
        ungrammatical = l1_ungrammatical;
    }
    else if (slt == "l2") {
        grammatical = l2_grammatical;
        ungrammatical = l2_ungrammatical;
    }
    else {
        print_error("Oops, language seems invalid");
    }

    grammatical.shuffle(0,-1);
    ungrammatical.shuffle(0,-1);
}

void
set_stimulus_direction() {
    int i;
    rand_vals.size = test_items.size;

    // assign 1 to lower half of rand items
    while (i < rand_vals.size/2) {
        rand_vals[i] = 1;
        i++;
    }
    rand_vals.shuffle(0, -1);

    i = 0;
    while (i < test_items.size) {
        if (rand_vals[i] == 0)
            test_items[i].sound_direction = LEFT_SIDE;
        else
            test_items[i].sound_direction = RIGHT_SIDE;
        i++;
    }
}

void
set_trial_numbers() {
    int i = 0;
    while (i < test_items.size) {
        test_items[i].id = i + 1;
        i++;
    }
}

int load_stimuli() {

    prepare_stimuli_lists();
    prepare_test_items();

    set_stimulus_direction();
    set_trial_numbers();

    return OK;
}

