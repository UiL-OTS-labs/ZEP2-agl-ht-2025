
import agl_records;
import defs;

string[] l1_stimuli = {
    "baa_daa_meu",
    "baa_geu_meu",
    "soe_daa_goo",
    "soe_geu_goo"
};

string[] l2_stimuli = {
    "baa_daa_goo",
    "baa_geu_goo",
    "soe_daa_meu",
    "soe_geu_meu"
};

int find_string_index(string[] haystack, string needle) {
    int i;
    int ret = -1;

    while (i < haystack.size) {
        if (haystack[i] == needle)
            return i;
    }

    return ret;
}

LanguageType determine_language(string stimulus) {
    LanguageType ret = LANGUAGE_NOT_SPECIFIED;
    if (find_string_index(l1_stimuli, stimulus)) {
        return L1;
    }
    else if (find_string_index(l2_stimuli, stimulus)) {
        return L2;
    }
    else {
        print_error("Oops stimulus: '" + stimulus + "', is neither L1 or L2\n");
        flush_error();
    }
    return ret;
}

string[] l1_grammatical = {
    "baa_daa_meu",
    "baa_geu_meu",
    "soe_daa_goo",
    "soe_geu_goo",
};

string[] l1_ungrammatical = {
    "meu_baa_daa",
    "geu_meu_baa",
    "daa_goo_soe",
    "goo_soe_geu",
}

// What is grammatical in l1 is ungrammatical in l2 and vice versa
string[] l2_grammatical;
string[] l2_ungrammatical;

// Based on the chosen language, store (un)grammatical stimuli names here.
// References are initialized in load_stimuli();
string[] grammatical;
string[] ungrammatical;

TestItem[] test_items = {};

string array_pop_string(string[] items) {
    string ret = items[items.size-1];
    items.size = items.size - 1;
    return ret;
}

void append_test_item(TestItem[] items, TestItem item) {
    items.size = items.size + 1;
    items[items.size - 1] = item;
}

TestItem
pop_test_item(TestItem[] items)
{
    TestItem ret = items[items.size - 1];
    items.size = items.size - 1;
    return ret;
}

TestItem
create_test_item(LanguageType language) {

    TestItem init;
    init.id = -1;
    init.language = language;
    init.sound_direction = PSEUDO_RANDOM_SIDE;

    return init; 
}

TestItem
create_grammatical() {

    string stimulus = array_pop_string(grammatical);

    LanguageType language = determine_language(stimulus);

    TestItem item  = create_test_item(language);
    item.test_type = TT_GRAMMATICAL;
    item.sndfn     = stimulus;

    return item;
}

TestItem
create_ungrammatical() {

    string stimulus;

    LanguageType language = determine_language(stimulus);

    TestItem item  = create_test_item(language);
    item.test_type = TT_UNGRAMMATICAL;
    item.sndfn     = array_pop_string(ungrammatical);

    return item;
}

// Selects the right list of grammatical and ungrammatical stimuli for language
// L1 or L2.
// And shuffles the grammatical and ungrammatical items.
void
prepare_stimuli_lists() {
    string slt = to_lowercase(expdb.participant.get_enum_field("language"));

    if (slt == "l1") {
        grammatical = l1_grammatical;
        ungrammatical = l1_ungrammatical;
    }
    else if (slt == "l2") {
        grammatical = l2_grammatical;
        ungrammatical = l2_ungrammatical;
    }
    else {
        print_error("Oops, language seems invalid");
    }

    grammatical.shuffle(0,-1);
    ungrammatical.shuffle(0,-1);
}

void
set_stimulus_direction() {
    int i;

    println("Set on basis of participant characteristics.");

    string first = expdb.participant.get_enum_field("first_side");

    if (first != "left" && first != "right") {
        print_error("oops first_sided ain'n left nor right...\n");
        flush_error();
    }

    Direction next_side = first == "left" ? LEFT_SIDE : RIGHT_SIDE;

    i = 0;
    while (i < test_items.size) {
        test_items[i].sound_direction = next_side;
        next_side = next_side == LEFT_SIDE ? RIGHT_SIDE : LEFT_SIDE;
        i++;
    }
}

void
prepare_test_items() {
    int i = 0;
    string GRAMMATICAL = "grammatical";
    string UNGRAMMATICAL = "ungrammatical";

    string grammar_first = expdb.participant.get_enum_field("first_grammar");

    while (i < 0) {
        bool is_even = i % 2 == 0;
        bool is_odd = i % 2 == 1;

        TestItem item;

        if (is_even && grammar_first == GRAMMATICAL) {
            item = create_grammatical();
        }
        else if(is_odd && grammar_first == GRAMMATICAL) {
            item = create_ungrammatical();
        }
        else if(is_even && grammar_first == UNGRAMMATICAL) {
            item = create_ungrammatical();
        }
        else if(is_odd && grammar_first == UNGRAMMATICAL) {
            item = create_grammatical();
        }
        else{
            print_error(
                "Oops unexpected parameters for choosing stimuli based on grammar\n"
            );
        }

        append_test_item(test_items, item);
        i++;
    }
    if (test_items.size != NUM_TEST_TRIALS) {
        print_error("Oops expected to have precisely 8 test_items here.");
    }
}

void
set_trial_numbers() {
    int i = 0;
    while (i < test_items.size) {
        test_items[i].id = i + 1;
        i++;
    }
}

int load_stimuli() {

    // initialize l2 grammars from l1.
    l2_ungrammatical = l1_grammatical;
    l2_grammatical = l1_ungrammatical;

    prepare_stimuli_lists();
    prepare_test_items();

    set_stimulus_direction();
    set_trial_numbers();

    return OK;
}

